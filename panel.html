<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Usuario - Profesionales y Turnos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; background: #f5f5f5; padding:2rem;}
  #panel { max-width: 800px; margin:auto; background:white; padding:2rem; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);}
  input, select { padding:0.5rem; margin:0.5rem 0; width:100%; border:1px solid #ccc; border-radius:6px;}
  button { padding:0.6rem 1.2rem; background:#0077cc; color:white; border:none; border-radius:6px; cursor:pointer; margin-top:0.5rem;}
  button:hover{background:#005fa3;}
  .profesional{border:1px solid #ccc; padding:1rem; border-radius:6px; margin-bottom:1rem;}
  .turnos{display:flex; flex-wrap: wrap;}
  .turno{border:1px solid #0077cc; padding:0.3rem 0.6rem; margin:2px; border-radius:4px; cursor:pointer;}
  .turno.active{background:#0077cc; color:white;}
</style>
</head>
<body>

<div id="panel">
  <h2>Panel de Usuario</h2>
  <p><strong>Username:</strong> <span id="username"></span></p>

  <h3>Agregar Profesional</h3>
  <input type="text" id="nuevoPro" placeholder="Nombre del profesional">
  <button id="agregarPro">Agregar Profesional</button>

  <h3>Profesionales</h3>
  <div id="profesionalesList"></div>

  <div id="msg"></div>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbywRYpRIYaGXnGzvNnZXiG79eTQYoDza-8oM0RHf8ioMLiqhCx7hzxwejxcnLeAAvH9eQ/exec"; // Reemplazar con tu Apps Script
const user = JSON.parse(localStorage.getItem("user"));
const usernameSpan = document.getElementById("username");
const profesionalesList = document.getElementById("profesionalesList");
const msg = document.getElementById("msg");

if(!user){
  alert("No estás logueado. Redirigiendo a login...");
  window.location.href="/login.html";
} else {
  usernameSpan.textContent = user.username;

  // Lista de profesionales del usuario
  let profesionales = [];
  let turnos = []; // turnos predefinidos (ejemplo 00:00 a 23:45 cada 15min)
  for(let h=0;h<24;h++){
    for(let m=0;m<60;m+=15){
      const hh = String(h).padStart(2,'0');
      const mm = String(m).padStart(2,'0');
      turnos.push(`${hh}:${mm}`);
    }
  }

  function renderProfesionales(){
    profesionalesList.innerHTML = "";
    profesionales.forEach((p,i)=>{
      const div = document.createElement("div");
      div.className = "profesional";
      div.innerHTML = `<h4>${p.nombre}</h4>
        <div class="turnos" id="turnos-${i}"></div>
        <button onclick="guardarTurnos(${i})">Guardar turnos</button>`;
      profesionalesList.appendChild(div);
      const turnosDiv = document.getElementById(`turnos-${i}`);
      turnos.forEach(t=>{
        const tSpan = document.createElement("span");
        tSpan.className="turno";
        tSpan.textContent=t;
        if(p.turnos.includes(t)) tSpan.classList.add("active");
        tSpan.onclick = ()=>{
          if(tSpan.classList.contains("active")){
            tSpan.classList.remove("active");
            p.turnos = p.turnos.filter(tt=>tt!==t);
          } else {
            tSpan.classList.add("active");
            p.turnos.push(t);
          }
        }
        turnosDiv.appendChild(tSpan);
      });
    });
  }

  // Agregar profesional
  document.getElementById("agregarPro").onclick = ()=>{
    const nombre = document.getElementById("nuevoPro").value.trim();
    if(!nombre){ msg.textContent="Escribe un nombre."; return;}
    profesionales.push({nombre, turnos:[]});
    renderProfesionales();
    document.getElementById("nuevoPro").value="";
  }

  // Guardar turnos del profesional en Apps Script
  window.guardarTurnos = async (index)=>{
    const pro = profesionales[index];
    try{
      const formData = new URLSearchParams();
      formData.append("action","saveProfessionalTurnos");
      formData.append("userId",user.userId);
      formData.append("nombre",pro.nombre);
      formData.append("turnos",JSON.stringify(pro.turnos));
      const res = await fetch(API_URL,{method:"POST",body:formData});
      const data = await res.json();
      if(data.status==="ok"){
        msg.style.color="green";
        msg.textContent=`Turnos de ${pro.nombre} guardados.`;
      } else {
        msg.style.color="red";
        msg.textContent=`Error: ${data.msg}`;
      }
    } catch(err){
      console.error(err);
      msg.style.color="red";
      msg.textContent="Error de conexión.";
    }
  }

  renderProfesionales();
}
</script>

</body>
</html>
